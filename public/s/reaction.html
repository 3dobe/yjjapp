

<div id="main-wrapper">
    <h1>听众反应</h1>

    <!-- Nav tabs -->
    <ul class="nav nav-tabs">
        <li><a class="ex-link" href="#tab-msg" data-toggle="tab">发言列表</a></li>
        <li><a class="ex-link" href="#tab-audience" data-toggle="tab">听众列表</a></li>
    </ul>

    <!-- Tab panes -->
    <div class="tab-content">
        <div class="tab-pane active" id="tab-msg">
            <table id="table-msg" class="table table-striped">
                <thead>
                <tr>
                    <th>昵称</th>
                    <th>发言</th>
                    <th>发言时间</th>
                </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        <div class="tab-pane" id="tab-audience">
            <table id="table-audience" class="table table-striped">
                <thead>
                <tr>
                    <th>昵称</th>
                    <th>在线时长</th>
                </tr>
                </thead>

                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    var $tableAudience = $('#table-audience'),
		$tableMsg = $('#table-msg');

    $('.nav-tabs a').click(function (e) {
        e.preventDefault();
		updateAll();
        $(this).tab('show');
    }).first().tab('show');
	
	updateAll();
	
	function updateAll() {
		updateAudienceList();
		updateMsgList();
	}
    function updateAudienceList() {
        var $tbody = $tableAudience.find('tbody');
        $.ajax({
            type: 'get',
            url: '/do/s/audiencelist',
            success: function(resObj) {
                if (! resObj['ok']) {
                    return alert('听众列表获取失败');
                }
                var audienceList = resObj['audienceList'],
                        tbodyHtml = audienceList.length ? _.reduce(audienceList, function(memo, audience) {
                    return memo + [
                        '<tr>',
                            '<td>' + audience.name + '</td>',
                            '<td>' + strTime(Date.now() - audience.jointime, true) + '</td>',
                        '</tr>'
                    ].join('');
                }, '') : [
                    '<tr>',
                        '<td colspan="2">没有记录</td>',
                    '</tr>'
                ].join('');
                $tbody.html(tbodyHtml);
            }
        });
    }
    function updateMsgList() {
        var $tbody = $tableMsg.find('tbody');
        $.ajax({
            type: 'get',
            url: '/do/s/msglist',
            success: function(resObj) {
                if (! resObj['ok']) {
                    return alert('发言列表获取失败');
                }
                var msgList = resObj['msgList'],
                        tbodyHtml = msgList.length ? _.reduce(msgList, function(memo, msg) {
                            return memo + [
                                '<tr>',
                                    '<td>' + msg.audienceName + '</td>',
                                    '<td>' + msg.text + '</td>',
                                    '<td>' + strTime(msg.sendtime) + '</td>',
                                '</tr>'
                            ].join('');
                        }, '') : [
                            '<tr>',
                                '<td colspan="3">没有记录</td>',
                            '</tr>'
                        ].join('');
                $tbody.html(tbodyHtml);
            }
        });
    }
</script>


