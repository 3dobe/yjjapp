


<div id="main-wrapper">
       <p>
            <a href="#/view" > back to index.</a>
       </p>

    <table id="table-filelist" class="table table-hover">
        <thead>
        <tr>
            <th>文件名</th>
            <th>文件大小</th>
            <th>下载次数</th>
            <th>操作</th>
        </tr>
        </thead>

        <tbody></tbody>
    </table>


    <form id="form-upload">
        <div class="form-group">
            <div class="input-group">
                <input type="file" class="form-control" name="file" />
            <span class="input-group-btn">
              <button type="submit" class="btn btn-primary">提交</button>
            </span>
            </div>
        </div>
    </form>
</div>

<script src="/lib/js/drawVerificationCode.js"></script>
<script>
    var $table = $('#table-filelist'),
            $tbody = $table.find('tbody'),
            $form = $('#form-upload');

    getFileList();

    var validExts = [
        'doc', 'docx', 'ppt', 'xls', 'txt',
        'jpg', 'jpeg', 'png', 'bmp', 'gif'
    ], $form = $('#form-upload');
    $form.on('submit', function(event) {
       event.preventDefault();  // 禁止默认转页行为
    }).find('[name="file"]').ajaxfileupload({
        submit_button: $form.find('[type="submit"]'),
        'action': '/do/s/savefile',
        valid_extensions: validExts,
        onCancel: function() {
            alert('请选择文件');
        },
        onComplete: function(resObj) {
            if (_.isObject(resObj) && 'status' in resObj && ! resObj['status']) {
                alert('仅支持格式 ' + validExts.join(', '));
                $form[0].reset();
                return;
            }
            if (_.isString(resObj)) {
                var resTxt = resObj;
                resTxt.match(/^[^\{]*(\{[\s\S]*\})[^\}]*$/);
                json = RegExp.$1;
                resObj = JSON.parse(json);
            }
            alert(resObj['msg']);
            if (! resObj['ok']) {
                $form[0].reset();
            } else {
                reloadFrame();
            }
        }
    });

    function getFileList() {
        $tbody.empty();
        $.ajax({
            type: 'get',
            url: '/do/s/filelist',
            success: function(resObj) {
                if (resObj['ok']) {
                    var files = resObj['files'];
                    _.each(files, function(file) {
                        $([
                            '<tr>',
                                '<td>' + file['name'] + '</td>',
                                '<td>' + Math.ceil(file['size'] / 1024) + ' KB </td>',
                                '<td>' + file['timesDown'] + '</td>',
                                '<td>' + <a href="#" class="button glow button-rounded button-flat">press me</a> '</td>,'
                            '</tr>'
                        ].join('')).appendTo($tbody);
                    });
                } else {
                    alert('文件列表获取失败');
                }
            }
        });
    }
</script>