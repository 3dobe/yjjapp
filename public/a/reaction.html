

<div id="main-wrapper">
    <p>
        <a href="#/view">返回主页</a>
    </p>


    <!-- Nav tabs -->
    <ul class="nav nav-tabs">
        <li><a class="ex-link" href="#tab-msg" data-toggle="tab">发言列表</a></li>
        <li><a class="ex-link" href="#tab-audience" data-toggle="tab">听众列表</a></li>
    </ul>

    <!-- Tab panes -->
    <div class="tab-content">
        <div class="tab-pane active" id="tab-msg">
            <table id="table-msg" class="table table-hover">
                <thead>
                <tr>
                    <th>昵称</th>
                    <th>发言</th>
                    <th>发言时间</th>
                </tr>
                </thead>

                <tbody></tbody>
            </table>
            <form  id="form-msg" action="/do/a/sendmsg" method="post">
                <div class="input-group">
                    <input type="text" name="msg" class="form-control" placeholder="请输入你想说的话">
                      <span class="input-group-btn">
                        <button class="btn btn-primary" type="submit" >发送消息</button>
                      </span>
                </div><!-- /input-group -->
            </form>
     </div>
        <div class="tab-pane" id="tab-audience">
            <table id="table-audience" class="table table-hover">
                <thead>
                <tr>
                    <th>昵称</th>
                    <th>在线时间</th>
                </tr>
                </thead>

                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    var $table_audience = $('#table-audience'),
        $table_msg = $('#table-msg');

    $('.nav-tabs a').click(function (e) {
        e.preventDefault();
        $(this).tab('show')
    }).first().tab('show');

    getAudienceList();
    getMsgList();

    $('#form-msg').ajaxForm({
        success: function(resObj) {
            var ok = resObj['ok'],
                    msg = resObj['msg'];
            alert(msg);
            if (ok) {
                reloadFrame();
            }
        }
    });

    function getAudienceList() {
        var $tbody = $table_audience.find('tbody');
        $tbody.empty();
        $.ajax({
            type: 'get',
            url: '/do/a/audiencelist',
            success: function(resObj) {
                if (resObj['ok']) {
                    var audienceList = resObj['audienceList'];
                    _.each(audienceList, function(audience) {
                        $([
                            '<tr>',
                                '<td>' + audience.name + '</td>',
                                '<td>' + strTime(Date.now() - audience.jointime, true) + '</td>',
                            '</tr>'
                        ].join('')).appendTo($tbody);

                    });
                } else {
                    alert('听众列表获取失败');
                }
            }
        });
    }

    function getMsgList() {
        var $tbody = $table_msg.find('tbody');
        $tbody.empty();
        $.ajax({
            type: 'get',
            url: '/do/a/msglist',
            success: function(resObj) {
                if (resObj['ok']) {
                    var msgList = resObj['msgList'];
                    _.each(msgList, function(msg) {
                        $([
                            '<tr>',
                                '<td>' + msg.audienceName + '</td>',
                                '<td>' + msg.text + '</td>',
                                '<td>' + strTime(msg.sendtime) + '</td>',
                            '</tr>'
                        ].join('')).appendTo($tbody);
                    });
                } else {
                    alert('发言列表获取失败');
                }
            }
        });
    }


</script>


